# Use cases for Vehicle (Type) Authorisations (VTA)

Source: EULEX PAVA

Main objectives: any process/application which supports the submission of an application for VTA, its automatic checks and the preparation of the reports necessary to sign the VTA.

## Parameters

> [!IMPORTANT]
> This document is an incomplete draft, to be reviewed by the working party. It serves only to implement the PoC.

## Subscriptions

The creation of a VTA Application by a Requesting Body to an Authorising Entity (the Permitting Body) is notified to the latter and inversely, the publication of the VTA is notified to the first. Within the process, if additional comments are to be provided in the scope of some submitted document, a notification SHOULD be sent to the party to provide them.

## Core Use cases

### Issue a new VTA Application (private only)

URI: `/process/VehicleAuthorisation/addC2T`

Display a sequence of forms, for private storage of the VTAA:

- Administrative organisational data: **links** to Applicant, involved subsystem NoBo's, DeBo's and AsBo's.
- Administrative contact data: **link** to the `foaf:Person` of the applying organisation, who serves as 'General Contact'. The user should be able to add this info to the [internal organisation](../ORG/ORGANISATION.md) graph.
- VTA `vpa:Case`s (of a SKOS-defined `vpa:permissionType`), each with a precise `vpa:Scope` (a VehicleType and a VehiclesCollection), a statement on the adequacy of the selected VTA case, the language used and the project name. The record in EVR of each vehicle number present in the VehiclesCollection is verified through an API to be provided.
- If applicable, a link to a pre-engagement resource.
- A separate listing on the applicable rules (linking to ERALEX instances where possible) is not

### Collect Evidence

URI: `/process/VehicleAuthorisation/addEvidenceToApplication`

Compile reusable collections of evidence documents, and link them to an application.

- The required 'Sets of Evidence' for the VTA case, as now implemented in 'OSS Documentation'. This collection is a [`era:DocumentSet`](http://data.europa.eu/949/DocumentSet) (subClassOf `vpa:Evidence`), consisting of links to resources, and if needed, files. Each instance in the collection SHOULD be provided with extra property values for data reuse in the automated process.
- The required 'Mapping tables'.

Data available through links is not repeated in the VTA Application. Example: all the VehicleType related info, including the Holder must be retrieved through that `Source`.

### Update an existing VTA Application (private only)

URI: `/data/VehicleAuthorisation/{identifier of the resource to update}`

A limited amount of properties can be changed without the need to re-apply. Also, documents can always be added to the 'Sets of Evidence'.

If an VTAIssue-dialogue has been created, the applicant can always add a reply, which is notified to the Authorising Entity.

### Assess or report on a VTA Application: presentations

See above.

### Signing a VTA Application Check, Assessment, Recommendation, Conclusion and Decision

These presentations SHOULD be signed using a `Verifiable Credential` on the data which uniquely defines it (given the presentation itself is not linked data). Both the integrity as the authority to sign should be embedded in the digital signature.

In order to avoid some `foaf:Agent` of an Authorising Entity to sign out of his/her authority, the organisational data should make use of `org:Membership` and `org:Role`. These roles can then be used to allow the Agent to execute the 'Signing'-use case.

### Other use cases

To be examined.

## Presentation

The presentation of VTA applications/authorisations is realised under the `/data/`-path (see further below), while the related data presentations (reports/check lists...) which need additional CONSTRUCT-queries are under `/presentations/`

URI: `/presentations/VehicleAuthorisation/{presentationGeneratorIdentifier}/{presentationIdentifier}

> [!CAUTION]
> Assessment reports, check lists and whatever presentation of collections of linked data are pre-generated automatically by CONSTRUCTing these triples from linked data (both submitted locally in the Pod, as by querying SPARQL-endpoints). The SPARQL CONSTRUCT queries to do so must be stored in a TTL-file, which is executed inside of the endpoint or LWS, in order to generate instances of a class representing a report/assessment. It is recommended to have the presentations created at the end of a process task if such is possible, but in most cases, several tasks will need to be executed first.

Presentations likely leave the creation space of the initial author towards other stakeholders:

- The (pre-assessment report) as generated by the applicant is normally not edited further. In order to inform the Applicant editing will be ignored, a role-based message might be needed in the dialogue presenting the report.
- The completeness and detailed reports will be regenerated by the authorising entity, which is able to add edits to it. These edits must be applied by a recognised user, which requires a login system to identify this user.
- The other reports as described in the PAVA can be treated in the same manner.

### Data model for a presentation generator

A presentation creates instances of new Classes, using a series of several CONSTRUCT queries. Given the complexity of some verifications, some [advanced, non-normative features of SHACL](https://www.w3.org/TR/shacl-af/) may also be required (See for instance [SCHACL-JS](https://www.w3.org/TR/shacl-js/#js-api)). Let us for instance describe the test on the validity of an EVN control number, of a Vehicle in the Scope of the Authorisation Case. This will - in the /data/ graph - appear as:

```rdf
:my_app a era:VehicleTypeAuthorisationApplication ;
  dct:identifier "My application"@en;
  
  vpa:constitutedBy [
    a era:VehicleTypeAuthorisationCase ;
    vpa:permissionType era-va-authcase:C2T ;
    vpa:concerns
      eratv:vt-myVehicleType ,
      [ a era:VehiclesSet ;
        rdfs:member [ a era:Vehicle ; dct:identifier "91 80 6187 520-2" ] # , [etc] other vehicles in the set
      ] ,
     [ a era:Vehicle ; dct:identifier "91 80 6187 525-7" ] ; # an extra vehicle
# other triples
```
In the C2T-completeness assessment we have to execute many checks on the generated presentation. This is therefore constructed into the `era:VehicleTypeAuthorisationAssessment` as:

```rdf
:pre-assessment a era:VehicleTypeAuthorisationAssessment ; #subClassof rdf:Bag
   era:assessmentType era-skos-at:PAVACompleteness ;
   rdfs:member [
      a era:AssessmentElement ; # subClassOf vpa:Compliance
      vpa:checkedSection :PAVACompletenessCheck-2 ;
      # vpa:isCompliant depends on outcome of the SHACL validation ("false|true"^^xsd:boolean) ;
   ] , [


   # other records of the completeness assessment
```

which requires the legislation to be machine readable as for instance:

```rdf
# The collection of checks as a Requirement, as located in the ERALEX graph
eralex:PAVA-AnnexII a vpa:Requirement ;
  rdfs:label "ANNEX II" ;
  rdfs:comment "Aspects for assessment by the authorising entity";
  dcterms:description "The information that shall be assessed by the authorising entity is specified per authorisation case. An (x) in the column for the applicable authorisation case indicates that this aspect is mandatory to assess for this authorisation case."@en ;
  vpa:sections eralex:PAVACompletenessCheck-1 , eralex:PAVACompletenessCheck-2 , eralex:PAVACompletenesssCheck-11 # , ...
  dcterms:source <http://data.europa.eu/eli/reg_impl/2018/545/2020-06-16#anx_II> .

# The collection of sections within that requirement some of which have automated shacl validation rulez.
eralex:PAVACompletenessCheck-1 a skos:Concept ;
  rdfs:label "1." ;
  skos:note "MANUAL ONLY - pre-engagement baseline is not machine-readable" ;
  rdfs:comment "Application consistent with the pre-engagement baseline (when applicable)" ;

eralex:PAVACompletenessCheck-2 a skos:Concept ;
  rdfs:label "2." ;
  rdfs:comment "The type of application is described in the application form" ;
  skos:note "AUTOMATIC" ;
  era:shaclShapeValidationRule <http://data.europa.eu/949/shapes/PAVA/CC2> .

#...
eralex:PAVACompletenesssCheck-11 a skos:Concept ;
  rdfs:label "11."
  rdfs:comment "The information about the vehicles is complete in the application form: vehicles are properly identified (EVN numbers, pre-reserved vehicle numbers, other identification)"
  skos:note "AUTOMATIC" ;
  era:shaclShapeValidationRule <http://data.europa.eu/949/shapes/PAVA/CC11a> , <http://data.europa.eu/949/shapes/PAVA/CC11b> .
```

For the validation-rules, we could have:

```shacl
<http://data.europa.eu/949/shapes/PAVA/CC2>
  a sh:NodeShape ;
  sh:targetClass era:VehicleTypeAuthorisationApplication ;
  sh:sparql [
    a sh:SPARQLConstraint ;   # This triple is optional
    sh:message "VA Applications contain a valid authorisation case. Valid combinations are not checked." ;
    sh:prefixes vpa: , era-va-authcase: ;
    sh:select """
  SELECT $this ?authcasetype
  WHERE {
    $this vpa:constitutedBy/vpa:permissionType ?authcasetype .
    FILTER (  !isLiteral(?authcasetype)                ||  # literal is not allowed
              !( ?authcasetype = era-va-authcase:C2T ) ||  # correct SKOS Concept for C2T
              !( ?authcasetype = era-va-authcase:NEW )     # correct SKOS Concept for NEW
              # incomplete
           )
    }
    """ ;
  ] .

<http://data.europa.eu/949/shapes/PAVA/CC11a>
  a sh:NodeShape ;
  sh:targetClass era:VehicleTypeAuthorisationApplication ;
  sh:sparql [
    a sh:SPARQLConstraint ;   # This triple is optional
    sh:message "VA Applications contain valid vehicle numbers (eventually in vehicle sets) as their scope." ;
    sh:prefixes vpa: , dct: ;
    sh:select """
  SELECT $this ?vehnumber
  WHERE {
    $this vpa:constitutedBy/vpa:concerns/dct:identifier ?vehnumber .
    FILTER (  
           )
    }
    """ ;
  ] .
```

## Machine-to-machine cycle

> Idea launched 17/12/2024 - non-formalised

1. Applicant client sends data on VVTAApplication and its contained library (`era:DocumentSet`) to a SPARQL-endpoint/LWS. In any case, the DocumentSet contains only links to ECDeclarations, as the underlying certificates are referenced.
2. Applicant must generate the pre-assessment triples under `/presentationss`
3. A notification is sent to an ERA listener/subscriber.
4. The listener launches SHACL-validation on the added triples and returns:
   1. The SHACL-validation report
   2. A proposed DC2T, for the Applicant to confirm by sending it back (with some authentication token added)
   3. If non-blocking validation, the draft assessment reports (Completeness, Detailed, Proposed Recommendation)
5. The creation of the assessment triples causes another Notification to be sent to the ERA Decision Maker.
6. On reception of the signed DC2T, the DM can sign the Recommendation and proposed Authorisation.
