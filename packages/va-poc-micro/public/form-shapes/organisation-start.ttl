# https://github.com/ULB-Darmstadt/shacl-form
@prefix dash:    <http://datashapes.org/dash#> .
@prefix dbpedia: <http://dbpedia.org/ontology/> .
@prefix dcat:    <http://www.w3.org/ns/dcat#> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix foaf:    <http://xmlns.com/foaf/0.1/> .
@prefix geo:     <http://www.opengis.net/ont/geosparql#> .
@prefix org:     <https://www.w3.org/ns/org#> .
@prefix owl:     <http://www.w3.org/2002/07/owl#> .
@prefix rdf:     <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:    <http://www.w3.org/2000/01/rdf-schema#> .
@prefix schema:  <http://schema.org/> .
@prefix sh:      <http://www.w3.org/ns/shacl#> .
@prefix skos:    <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd:     <http://www.w3.org/2001/XMLSchema#> .
@prefix prov:    <http://www.w3.org/ns/prov#> .
@prefix ex:      <http://example.org/> .
@prefix as:      <https://www.w3.org/ns/activitystreams#> .
@prefix eraUi:   <http://data.europa.eu/949/ui/> .
@prefix locn:    <http://www.w3.org/ns/locn#> .


@prefix era:      <http://data.europa.eu/949/> .
@prefix era-sh:   <http://data.europa.eu/949/shapes/> .
@prefix rorg:     <http://data.europa.eu/949/organisations/> .
@prefix lorg:     <http://data.europa.eu/949/organisations/sites/> .
@prefix locs:     <http://data.europa.eu/949/organisations/locations/> .
@prefix uorg:     <http://data.europa.eu/949/organisations/units/> .
@prefix orgr:     <http://data.europa.eu/949/organisations/roles/> .

@prefix era-organisation-roles: <http://data.europa.eu/949/concepts/organisation-roles/> .

org:FormalOrganization rdfs:subClassOf org:Organization .
org:OrganizationalUnit rdfs:subClassOf org:Organization .
era:Body rdfs:subClassOf org:Organization .

era-sh:OrgOrFormalOrgShape a sh:NodeShape, rdfs:Class ;
  rdfs:label "Organisation entry"@en ;
  rdfs:comment "Start a new structure by choosing whether you manage a formal holding or an operational organisation."@en ;
  # dash:stem rorg: ; DO NOT MINT RESOURCES OF THIS TYPE
  # Start of entry must happen with FormalOrg OR Org. Some stakeholders have no holdings/groups/corporations.
  sh:property [
    sh:or (
      [
        sh:class org:FormalOrganisation ;
        sh:nodeKind sh:IRI ;
        rdfs:label "Mother Holding or Group, active worldwide"
      ]
      [
        sh:class org:Organization ;
        sh:nodeKind sh:IRI ;
        rdfs:label "An operational organization, active in one country"
      ]
    );
    sh:path owl:sameAs;
    sh:name "Core level organisation";
    sh:description "Data for the top level organisation, an international holding if needed";
    sh:minCount 1;
    sh:maxCount 1 # the form intends to not allow multi-corporate orgs
  ].

# Formal Organisations do not have orgCode, and they only have a org:hasRegisteredSite to locate them.
#           can have subOrganisations but no units
era-sh:FormalOrganisationShape a sh:NodeShape, rdfs:Class ;
  rdfs:label "Formal organisation"@en ;
  rdfs:comment "Model a legally recognised holding or group that oversees subsidiary organisations."@en ;
  dash:stem rorg: ;
  sh:targetClass org:FormalOrganization ;
  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype xsd:string ;
    sh:name "Name of the Holding or Group"@en ;
    sh:description "The legally recognized name of the mother holding or group. Do NOT include locations in this name." ;
    sh:minCount 0 ; sh:maxCount 1
  ] ;
  sh:property [
    sh:path rdfs:comment ;
    sh:datatype xsd:string ;
    dash:singleLine false ;
    sh:name "Description of the Holding or Group"@en ;
    sh:description "A description of the mother holding or group. Do NOT include locations in this name." ;
    sh:minCount 0 ; sh:maxCount 1
  ] ;
  sh:property [
    sh:path org:hasSubOrganization;
    sh:name "Subsidiary organisations";
    sh:nodeKind sh:IRI ;
    sh:class org:Organization ;
    sh:description "An organization which is part of this mother holding or group" ;
    sh:minCount 0 # Orgs can be added later
  ];
  sh:property [
    sh:path org:hasRegisteredSite ;
    sh:name "Legal Address" ;
    sh:description "The Site where this Holding or Group has its legal address." ;
    sh:minCount 0 ; # a holding MUST have a legal address, can be added later
    sh:maxCount 1 ; # a holding can only have one legal address.
    sh:nodeKind sh:IRI ;
    sh:class org:Site ;
  ].
  # sh:property [
  #   sh:name "Formal Organisation - editorial data";
  #   sh:path skos:changeNote ;
  #   sh:node era-sh:OrgRecordShape ;
  #   sh:minCount 1 ; # mandatory date of record and change.
  # ].

era-sh:OrganisationShape a sh:NodeShape, rdfs:Class ;
  rdfs:label "Organisation"@en ;
  rdfs:comment "Capture an operational organisation with its identifier, registered sites, and units."@en ;
  dash:stem rorg: ;
  sh:targetClass org:Organization ;
  # Organisations MUST have orgCode, and they have org:hasRegisteredSite and hasPrimarySite.
  # They can have other organisations as members.
  # They must define their operational sites through the sites of their UNITS.
  sh:property [
    sh:maxCount 1 ;
    sh:minCount 1 ;
    sh:path skos:prefLabel ;
    sh:datatype xsd:string ;
    sh:name "Name of the Organization"@en ;
    sh:description "The legally recognized name of the organisation. Do NOT include locations in this name." ;
  ] ;
  sh:property [
    sh:minCount 0 ; # Not mandatory
    sh:path org:hasSubOrganization;
    sh:nodeKind sh:IRI ;
    sh:class org:Organization ;
    sh:name "Subsidiary organisation";
    sh:description "An organization, as a separate legal entity, which is >50% part of this organization" ;
  ];
  sh:property [
    # sh:maxCount 1 ;
    sh:minCount 0 ; # Site CAN be added later as well
    sh:path org:hasRegisteredSite ;
    sh:nodeKind sh:IRI ;
    sh:class org:Site ;
    sh:name "Legal Address" ;
    sh:description "The Site where this organization has its legal address." ;
  ] ;
  sh:property [
    sh:path org:hasPrimarySite ;
    sh:nodeKind sh:IRI ;
    sh:class org:Site ;
    sh:name "Contact Address" ;
    sh:description "The Site where this organization can be contacted." ;
    sh:minCount 0 ; # a org CAN have a prim site address
    # sh:maxCount 1 ;
  ];
  # Organizations do not directly use hasSite, as this must happen through their Units.
  sh:property [
    sh:path org:hasUnit ;
    sh:nodeKind sh:IRI ;
    sh:class org:OrganizationalUnit ;
    sh:name "Units or Departments within this organisation" ;
    sh:description "Units or departments which fall under the leadership of this organization." ;
    sh:minCount 0 ; # a org CAN have no Units, in that case, it is assumed all activities run in one location.
    # sh:maxCount 10 ; in fact no limits exist
  ];
  sh:property [
    sh:path era:role ;
    sh:nodeKind sh:IRI ;
    sh:class era:OrganisationRole ;
    sh:name "The role this Organisation can play in the ERA systems/processes"@en ;
    sh:description "An Organisation SHOULD play an organisational role"@en ;
    sh:minCount 0
  ].

era-sh:UnitShape a sh:NodeShape, rdfs:Class ;
  rdfs:label "Organisational unit"@en ;
  rdfs:comment "Describe a department or unit that operates within a parent organisation."@en ;
  dash:stem uorg: ;
  sh:targetClass org:OrganizationalUnit ;
  # An Organization such as a department or support unit which is part of some larger Organization and only has full recognition within the context of that Organization.
  # In particular the unit would not be regarded as a legal entity in its own right.
  # Do not have an orgCode, but are located on a site.
  sh:property [
    sh:path skos:prefLabel ;
    xsd:datatype xsd:string ;
    sh:name "Name of the Unit/Department"@en;
    sh:description "The name as it is known in the organisation structure. Do NOT include locations in this name.";
    sh:minCount 1;
  ];
  sh:property [
    sh:path skos:altLabel ;
    xsd:datatype xsd:string ;
    sh:name "abbreviation of the Unit/Department"@en;
    sh:description "The abbreviation as it is known in the organisation structure.";
    sh:minCount 1;
    sh:maxLength 10;
  ];
  sh:property [
    sh:path org:hasSite ;
    sh:nodeKind sh:IRI ;
    sh:class org:Site ;
    sh:name "legal address of the Unit" ;
    sh:description "The Site where this Unit is located and its teams are working." ;
    sh:minCount 0 ; # a unit MUST have a site address, can be added later
    sh:maxCount 3 ; # a unit can be housed in 3 different sites.
  ];
  sh:property [
    sh:path org:unitOf ;
    sh:nodeKind sh:IRI ;
    sh:class org:FormalOrganization ; # ontology limit/error!?
    sh:name "formal organisation to which this Unit belongs" ;
    sh:description "The Formal Organisation to which the Unit belongs";
    sh:minCount 0
  ];
  sh:property [
    sh:path era:role ;
    sh:nodeKind sh:IRI ;
    sh:class era:OrganisationRole ;
    sh:name "role this Unit can play in the ERA systems/processes"@en ;
    sh:description "A Unit within an Organisation COULD play an individual organisational role"@en ;
    sh:minCount 0
  ].

era-sh:SiteShape a sh:NodeShape, rdfs:Class ;
  rdfs:label "Organisation site"@en ;
  rdfs:comment "Capture the name, address, and location of an organisation site."@en ;
  dash:stem lorg: ;
  sh:targetClass org:Site ;
  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype xsd:string ;
    sh:name "site name"@en ;
    sh:description "The human-readable name of the site."@en ;
    sh:minCount 1 ;
    sh:maxCount 1
  ] ;
  sh:property [
    sh:path org:siteAddress ;
    sh:name "site address"@en ;
    sh:nodeKind sh:IRI ;
    sh:class locn:Address ;
    sh:description "The postal address associated with this site."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ] ;
  sh:property [
    sh:path org:siteOf ;
    sh:name "belongs to site"@en ;
    sh:nodeKind sh:IRI ;
    sh:class org:Organization ;
    sh:description "Link back to the organisation that owns this site."@en ;
    sh:minCount 0 ;
  ] ;
  sh:property [
    sh:path org:location ;
    sh:name "geolocation"@en ;
    sh:nodeKind sh:IRI ;
    sh:class dcterms:Location ;
    sh:description "Spatial location represented as geometry and optional description."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ].

era-sh:LocationShape a sh:NodeShape, rdfs:Class ;
  rdfs:label "Location"@en ;
  rdfs:comment "Geospatial information attached to a site."@en ;
  dash:stem locs: ;
  sh:targetClass dcterms:Location ;
  sh:property [
    sh:path skos:prefLabel ;
    sh:name "Location label"@en ;
    sh:order 0 ;
    sh:description "Label for the site location."@en ;
    sh:minCount 1 ;
    sh:maxCount 1
  ];
  sh:property [
    sh:path dcterms:description ;
    sh:name "Location description"@en ;
    sh:order 1 ;
    sh:description "Narrative description of the site location."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ];
  sh:property [
    sh:path geo:asWKT ;
    sh:datatype geo:wktLiteral ;
    sh:name "Coordinates"@en ;
    sh:order 2 ;
    sh:description "Well-known text (WKT) geometry, e.g. POINT(8.65 49.87)."@en ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:pattern "^POINT\\([+\\-]?(?:[0-9]*[.])?[0-9]+ [+\\-]?(?:[0-9]*[.])?[0-9]+\\)$|^POLYGON\\(\\((?:[+\\-]?(?:[0-9]*[.])?[0-9]+[ ,]?){3,}\\)\\)$"
  ] .

era-sh:AddressNodeShape a sh:NodeShape, rdfs:Class ;
  rdfs:label "Postal address"@en ;
  rdfs:comment "Structured postal address details in LOCN format."@en ;
  dash:stem locs: ;
  sh:targetClass locn:Address ;
  sh:property [
    sh:path locn:fullAddress ;
    sh:datatype xsd:string ;
    sh:name "Full address"@en ;
    sh:description "Complete address as a single string."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ] ;
  sh:property [
    sh:path locn:postName ;
    sh:datatype xsd:string ;
    sh:name "City or town"@en ;
    sh:description "City or town component."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ] ;
  sh:property [
    sh:path locn:postCode ;
    sh:datatype xsd:string ;
    sh:name "Postal code"@en ;
    sh:description "Postal or ZIP code."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ] ;
  sh:property [
    sh:path locn:thoroughfare ;
    sh:datatype xsd:string ;
    sh:name "Street"@en ;
    sh:description "Street name and number."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ] ;
  sh:property [
    sh:path locn:adminUnitL1 ;
    sh:nodeKind sh:IRI ;
    owl:imports <https://raw.githubusercontent.com/Interoperable-data/automate-va/refs/heads/dev-lws/TTL/countries.ttl> ;
    sh:class skos:Concept ;
    sh:name "Country"@en ;
    sh:description "Reference to a country concept."@en ;
    sh:minCount 0 ;
    sh:maxCount 1
  ].

era-sh:OrganisationRoleShape a sh:NodeShape ;
  rdfs:label "Organisational role"@en ;
  rdfs:comment "ERA roles this organisation or unit plays in the railway system processes."@en ;
  dash:stem orgr: ;
  sh:targetClass era:OrganisationRole ;
  sh:property [
    sh:path skos:prefLabel ;
    sh:nodeKind sh:Literal ;
    sh:datatype xsd:string;
    sh:name "Description of the role";      
    sh:minCount 1; sh:maxCount 1; # Better mandatory
    sh:message "Each Organisational Role MUST have a human readable description"@en ;
    sh:severity sh:Violation
  ];
  sh:property [
    sh:path era:roleOf ;
    sh:nodeKind sh:IRI ;
    sh:class org:Organization;
    sh:name "The Organisation(al Unit) which plays the role";      
    sh:minCount 0; sh:maxCount 1; # MINCount MUST be 0 (or it forces new org update)
    sh:message "Each Organisational Role MUST be played by exactly one Organisation(al Unit)"@en ;
    sh:severity sh:Violation
  ];
  sh:property [
    sh:path era:hasOrganisationRole ;
    sh:nodeKind sh:IRI ;
    sh:class skos:Concept ;
    sh:minCount 1; sh:maxCount 1; # one role per resource
    owl:imports <https://data-interop.era.europa.eu/era-vocabulary/era-skos> ;
    sh:in (
      era-organisation-roles:IM 
      era-organisation-roles:RU  
      era-organisation-roles:Owner
	    era-organisation-roles:Keeper 
      era-organisation-roles:Applicant 
      era-organisation-roles:ECM 
      era-organisation-roles:Manufacturer
      era-organisation-roles:NSA 
      era-organisation-roles:MWS 
      era-organisation-roles:NIB 
      era-organisation-roles:CAB 
      era-organisation-roles:AB
      era-organisation-roles:NAB 
      era-organisation-roles:CB 
      era-organisation-roles:EUBody 
      era-organisation-roles:EC 
      era-organisation-roles:CB 
      era-organisation-roles:TDGCA 
      era-organisation-roles:RB
      era-organisation-roles:SB
      era-organisation-roles:AuthEntity
    );
    sh:name "The role played by the Body"@en ;
    sh:message "Each Organisational Role MUST be defined by exactly one Role"@en;
    sh:severity sh:Violation
  ];
  sh:property [
    sh:path era:organisationCode ;
    sh:pattern "^[A-Z0-9]{4}";
    sh:maxCount 1 ; sh:minCount 1 ;
    sh:minLength 4;  sh:maxLength 4;
    sh:name "Organisation Code" ;
    sh:description "Each Role - Body combination can be identified by an Organisation Code";
    sh:message "Each Organisational Role MUST have exactly one Organisation Code"@en;
    sh:severity sh:Violation
  ].
sh:OrganisationRolePermissionShape a sh:NodeShape ;
 rdfs:label "Organisation's formal permission" ;
 rdfs:comment "The (subClassOf) vpa:Permission which allows the Organisation to play the role."@en ;
 # TODO: Depending on the role SKOS, the targetClass is different:
 # For a RU, we should provide the era:Permission of type `SSC`
 # see all cases on the Github: https://github.com/Interoperable-data/automate-va/tree/dev-lws/TTL/form-shapes
 # 
 .