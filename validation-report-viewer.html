<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>SHACL Validation Report Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://unpkg.com/n3/browser/n3.min.js"></script>
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            margin: 1rem 1.5rem;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0 0 .75rem;
        }

        section.controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        input[type=file] {
            font-size: .9rem;
        }

        textarea {
            width: 100%;
            height: 140px;
            font-family: monospace;
        }

        button {
            cursor: pointer;
        }

        summary {
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1rem;
            font-size: .8rem;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: .4rem .5rem;
            vertical-align: top;
        }

        th {
            background: #f5f5f5;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        tbody tr:hover {
            background: #fafafa;
        }

        .sev-Violation {
            background: #ffe5e5;
        }

        .sev-Warning {
            background: #fff4e0;
        }

        .sev-Info,
        .sev-Information,
        .sev-Notice {
            background: #f0f4f9;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: .65rem;
            font-weight: 600;
            letter-spacing: .5px;
            text-transform: uppercase;
        }

        .badge.Violation {
            background: #d40000;
            color: #fff;
        }

        .badge.Warning {
            background: #ff8c00;
            color: #222;
        }

        .badge.Info,
        .badge.Information,
        .badge.Notice {
            background: #5d7ba0;
            color: #fff;
        }

        #summary {
            margin-top: .75rem;
            font-size: .8rem;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-top: .5rem;
        }

        .filters label {
            font-size: .7rem;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .path,
        .iri {
            font-family: monospace;
            white-space: nowrap;
        }

        .small {
            font-size: .65rem;
            opacity: .7;
        }

        #status {
            font-size: .7rem;
            margin-top: .5rem;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .counts {
            margin-top: .5rem;
            font-size: .7rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        .sticky-bar {
            position: sticky;
            top: 0;
            background: #fff;
            padding: .5rem 0;
            z-index: 3;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <h1>SHACL Validation Report Viewer</h1>
    <p style="font-size:.75rem;max-width:840px">Open one or more Turtle validation report files generated by the EC
        SHACL service. The page parses them client-side using the N3 library (no upload). Local file access requires a
        manual file selection due to browser security.</p>
    <section class="controls">
        <div>
            <label>Select Turtle report(s):
                <input type="file" id="fileInput" multiple accept=".ttl,.txt,.turtle" />
            </label>
        </div>
        <div>
            <button id="parseClipboardBtn" title="Parse content pasted below">Parse Pasted</button>
            <button id="clearBtn">Clear</button>
        </div>
        <div>
            <label>Filter text:
                <input type="text" id="textFilter" placeholder="Search focus/message/path" />
            </label>
        </div>
        <div>
            <label>Hide non Viol/Warn:
                <input type="checkbox" id="hideNonViolations" checked />
            </label>
        </div>
    </section>

    <details style="margin-top:.75rem;">
        <summary>Paste Turtle validation report (optional)</summary>
        <textarea id="pasteArea" placeholder="Paste validation-result.ttl here..."></textarea>
    </details>

    <div id="summary"></div>
    <div class="counts" id="counts"></div>
    <div class="sticky-bar filters" id="severityFilters"></div>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Severity</th>
                <th>Focus Node</th>
                <th>Path</th>
                <th>Message</th>
                <th>Constraint</th>
                <th>Value</th>
                <th>Source Shape</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <pre id="status"></pre>

    <script>
        const SH = 'http://www.w3.org/ns/shacl#';
        const RDF = 'http://www.w3.org/1999/02/22-rdf-syntax-ns#';

        const fileInput = document.getElementById('fileInput');
        const pasteBtn = document.getElementById('parseClipboardBtn');
        const clearBtn = document.getElementById('clearBtn');
        const tableBody = document.querySelector('#resultsTable tbody');
        const summaryDiv = document.getElementById('summary');
        const statusPre = document.getElementById('status');
        const countsDiv = document.getElementById('counts');
        const hideNonViolations = document.getElementById('hideNonViolations');
        const textFilter = document.getElementById('textFilter');
        const severityFiltersDiv = document.getElementById('severityFilters');

        let allResults = [];
        let activeSeverities = new Set();

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) loadFiles([...fileInput.files]);
        });

        pasteBtn.addEventListener('click', () => {
            const txt = document.getElementById('pasteArea').value.trim();
            if (!txt) return; parseAndAccumulate(txt, 'pasted-input');
        });

        clearBtn.addEventListener('click', () => {
            allResults = []; tableBody.innerHTML = ''; summaryDiv.textContent = ''; countsDiv.innerHTML = ''; severityFiltersDiv.innerHTML = ''; statusPre.textContent = '';
        });

        hideNonViolations.addEventListener('change', render);
        textFilter.addEventListener('input', render);

        function loadFiles(files) {
            files.forEach(f => {
                const reader = new FileReader();
                reader.onload = e => parseAndAccumulate(e.target.result, f.name);
                reader.onerror = () => logStatus('Error reading ' + f.name + ': ' + reader.error);
                reader.readAsText(f);
            });
        }

        function logStatus(msg) { statusPre.textContent += msg + '\n'; }

        async function parseAndAccumulate(turtle, label) {
            try {
                const parser = new N3.Parser();
                const quads = [];
                parser.parse(turtle, (err, quad) => {
                    if (err) { logStatus('Parse error in ' + label + ': ' + err.message); return; }
                    if (quad) quads.push(quad); else { logStatus('Parsed ' + quads.length + ' triples from ' + label); extractValidationResults(quads); render(); }
                });
            } catch (e) { logStatus('Failed parsing ' + label + ': ' + e.message); }
        }

        function extractValidationResults(quads) {
            const bySubject = new Map();
            for (const q of quads) { if (!bySubject.has(q.subject.id)) bySubject.set(q.subject.id, []); bySubject.get(q.subject.id).push(q); }
            for (const q of quads) {
                if (q.predicate.id === RDF + 'type' && q.object.id === SH + 'ValidationResult') {
                    allResults.push(collectProps(q.subject.id, bySubject));
                }
            }
        }

        function collectProps(subjId, bySubject) {
            const quads = bySubject.get(subjId) || []; const out = { id: subjId };
            for (const q of quads) {
                const p = q.predicate.id; const o = q.object;
                switch (p) {
                    case SH + 'focusNode': out.focusNode = nodeRepr(o); break;
                    case SH + 'resultPath': out.resultPath = pathRepr(o, bySubject); break;
                    case SH + 'resultMessage': out.message = literalValue(o); break;
                    case SH + 'resultSeverity': out.severity = compactIri(o.id); break;
                    case SH + 'sourceConstraintComponent': out.constraint = compactIri(o.id); break;
                    case SH + 'sourceShape': out.sourceShape = nodeRepr(o); break;
                    case SH + 'value': out.value = nodeRepr(o); break;
                }
            }
            return out;
        }

        function literalValue(term) { if (term.termType === 'Literal') return term.value; return nodeRepr(term); }
        function nodeRepr(term) {
            if (term.termType === 'Literal') {
                if (term.language) return JSON.stringify(term.value) + '@' + term.language;
                if (term.datatype && term.datatype.id && term.datatype.id !== 'http://www.w3.org/2001/XMLSchema#string') return JSON.stringify(term.value) + '^^' + compactIri(term.datatype.id);
                return JSON.stringify(term.value);
            }
            if (term.termType === 'BlankNode') return '_:' + term.id;
            if (term.termType === 'NamedNode') return compactIri(term.id);
            return term.id;
        }
        function pathRepr(node, bySubject) { if (node.termType === 'NamedNode') return compactIri(node.id); if (node.termType === 'BlankNode') { const qs = bySubject.get(node.id) || []; for (const q of qs) { if (q.predicate.id === SH + 'inversePath') return 'inverse ' + nodeRepr(q.object); if (q.predicate.id === SH + 'alternativePath') return 'alt(...)'; } return '_:' + node.id; } return nodeRepr(node); }
        function compactIri(iri) { if (!iri) return ''; const cut = Math.max(iri.lastIndexOf('#'), iri.lastIndexOf('/')); const local = cut >= 0 ? iri.slice(cut + 1) : iri; return local || iri; }

        function buildSeverityFilters() {
            severityFiltersDiv.innerHTML = '';
            // Normalize severities: map missing/empty to 'Unknown'
            const severities = [...new Set(allResults.map(r => (r.severity && r.severity.trim()) ? r.severity : 'Unknown'))].sort();
            // On first build, activate ALL severities so nothing is accidentally filtered out
            if (!activeSeverities.size) {
                severities.forEach(s => activeSeverities.add(s));
            }
            severities.forEach(s => {
                const id = 'sev-' + s;
                const checked = activeSeverities.has(s) ? 'checked' : '';
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" id="${id}" ${checked} data-sev="${s}"> ${s}`;
                severityFiltersDiv.appendChild(label);
            });
            if (!severityFiltersDiv.dataset.bound) {
                severityFiltersDiv.addEventListener('change', e => {
                    if (e.target && e.target.dataset.sev) {
                        e.target.checked ? activeSeverities.add(e.target.dataset.sev) : activeSeverities.delete(e.target.dataset.sev);
                        renderTable();
                    }
                });
                severityFiltersDiv.dataset.bound = '1';
            }
        }

        function render() { if (!allResults.length) { summaryDiv.textContent = 'No validation results loaded.'; tableBody.innerHTML = ''; countsDiv.innerHTML = ''; return; } buildSeverityFilters(); renderTable(); }
        function renderTable() {
            const filterText = (textFilter.value || '').toLowerCase();
            const hidePass = hideNonViolations.checked;
            const rows = [];
            let stats = { total: 0 };
            for (const r of allResults) {
                // Ensure severity normalized
                const sev = (r.severity && r.severity.trim()) ? r.severity : 'Unknown';
                stats[sev] = (stats[sev] || 0) + 1; stats.total++;
                if (hidePass && !/(Violation|Warning)/i.test(sev)) continue;
                if (activeSeverities.size && !activeSeverities.has(sev)) continue;
                const blob = (r.focusNode || '') + ' ' + (r.resultPath || '') + ' ' + (r.message || '');
                if (filterText && !blob.toLowerCase().includes(filterText)) continue;
                rows.push({ ...r, severity: sev });
            }
            tableBody.innerHTML = '';
            rows.forEach((r, i) => {
                const tr = document.createElement('tr');
                tr.classList.add('sev-' + (r.severity || 'Unknown'));
                tr.innerHTML = `<td>${i + 1}</td><td><span class="badge ${r.severity}">${r.severity}</span></td><td class="iri" title="${r.focusNode || ''}">${shorten(r.focusNode)}</td><td class="path" title="${r.resultPath || ''}">${shorten(r.resultPath)}</td><td>${escapeHtml(r.message || '')}</td><td class="small" title="${r.constraint || ''}">${r.constraint || ''}</td><td class="small" title="${r.value || ''}">${shorten(r.value)}</td><td class="small" title="${r.sourceShape || ''}">${shorten(r.sourceShape)}</td>`;
                tableBody.appendChild(tr);
            });
            summaryDiv.textContent = `Showing ${rows.length} of ${allResults.length} validation results.`;
            countsDiv.innerHTML = Object.entries(stats)
                .filter(([k]) => k !== 'total')
                .map(([k, v]) => `<div>${k}: ${v}</div>`)
                .join('') + `<div>Total: ${stats.total}</div>`;
        }

        function shorten(v) { if (!v) return ''; return v.length > 60 ? v.slice(0, 57) + 'â€¦' : v; }
        function escapeHtml(s) { return s.replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c])); }
    </script>
</body>

</html>