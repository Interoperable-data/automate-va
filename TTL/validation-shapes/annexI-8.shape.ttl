@base <http://data.europa.eu/949/> .
@prefix era: <http://data.europa.eu/949/> .
@prefix era-sh: <http://data.europa.eu/949/shapes/> .

# General
@prefix sh:   <http://www.w3.org/ns/shacl#> .

era-sh:AnnexI-8 a sh:NodeShape ;
    sh:targetClass era:VehicleTypeAuthorisationCase ;
    sh:name "(I) 8. Assessment bodies information"@en ;
    sh:sparql [
        sh:name "Missing assessment body for CLD certificate"@en ;
        sh:message "CLD certificate (?doc) supporting this case lacks a creator role (era:roleOf)."@en ;
        sh:severity sh:Violation ;
        sh:select """
            PREFIX era: <http://data.europa.eu/949/>
            PREFIX vpa: <http://w3id.org/vpa#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX dcterms: <http://purl.org/dc/terms/>
            SELECT $this ?evidence ?doc
            WHERE {
                ?evidence vpa:supportsCase $this ;
                          rdfs:member ?doc .
                ?doc a era:CLD .
                FILTER NOT EXISTS {
                    ?doc dcterms:creator/era:roleOf ?cab .
                }
            }
        """
    ] ;
    sh:sparql [
    sh:name "Missing assessment body for underlying certificate of ECDeclaration"@en ;
    sh:message "Underlying certificate (?subdoc) of ECDeclaration (?doc) lacks a creator role (era:roleOf)."@en ;
    sh:severity sh:Violation ;
    sh:select """
        PREFIX era: <http://data.europa.eu/949/>
        PREFIX vpa: <http://w3id.org/vpa#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        PREFIX dcterms: <http://purl.org/dc/terms/>
        SELECT $this ?evidence ?doc ?subdoc
        WHERE {
            ?evidence vpa:supportsCase $this ;
                        rdfs:member ?doc .
            ?doc a era:ECDeclaration ;
                dcterms:requires/rdfs:member ?subdoc .
            ?subdoc a era:CLD .
            FILTER NOT EXISTS {
                ?subdoc dcterms:creator/era:roleOf ?cab .
            }
        }
    """
    ] ;
    sh:sparql [
    sh:name "Missing assessment bodies summary (CLD)"@en ;
    sh:message "There are {$missing} CLD certificate(s) supporting this case without assessment body info."@en ;
    sh:severity sh:Violation ;
    sh:select """
        PREFIX era: <http://data.europa.eu/949/>
        PREFIX vpa: <http://w3id.org/vpa#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        PREFIX dcterms: <http://purl.org/dc/terms/>
        SELECT $this (COUNT(?doc) AS ?missing)
        WHERE {
            ?evidence vpa:supportsCase $this ;
                      rdfs:member ?doc .
            ?doc a era:CLD .
            FILTER NOT EXISTS { ?doc dcterms:creator/era:roleOf ?cab }
        }
        GROUP BY $this
        HAVING (COUNT(?doc) > 0)
    """
] .
