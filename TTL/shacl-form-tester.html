<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SHACL Form Tester</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script type="importmap">
    {   "imports": { 
        "@ulb-darmstadt/": "https://cdn.jsdelivr.net/npm/@ulb-darmstadt/shacl-form@1.9.2/dist/",
        "@demoutiez/": "https://ai.test-era.europa.eu/iss/static/shacl-form/" } }
    </script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        body {
            height: 100vh;
        }

        #container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
        }

        #form-panel {
            flex: 3 1 0;
            min-width: 0;
            padding: 1em 1em 1em 1em;
            box-sizing: border-box;
            border-right: 1px solid #ccc;
            background: #fafbfc;
        }

        #rdf-panel {
            flex: 2 1 0;
            min-width: 0;
            padding: 1em;
            box-sizing: border-box;
            background: #f5f5f5;
            overflow-x: auto;
            overflow-y: auto;
        }

        #rdf-panel pre {
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.95em;
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 0.5em;
            border-radius: 4px;
            height: 90vh;
            margin: 0;
        }

        #topbar {
            width: 100vw;
            background: #eaeaea;
            padding: 0.5em 1em;
            box-sizing: border-box;
            border-bottom: 1px solid #ccc;
            display: flex;
            align-items: center;
            gap: 1em;
        }

        select {
            font-size: 1em;
            padding: 0.2em 0.5em;
        }

        label {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <script>
        function updateShaclForm() {
            const select = document.getElementById('shape-select');
            const form = document.getElementById('shaclform');
            const output = document.getElementById('output');
            // Replace only the shacl-form element
            const newForm = document.createElement('shacl-form');
            newForm.setAttribute('id', 'shaclform');
            newForm.setAttribute('data-shapes-url', select.value);
            newForm.setAttribute('data-collapse', 'open');
            newForm.setAttribute('data-submit-button', 'Submit');
            newForm.setAttribute('data-language', 'en');
            newForm.setAttribute('data-values-subject', 'http://data.europa.eu/949/organisations/sites/ERA')
            newForm.style.width = '100%';
            form.parentNode.replaceChild(newForm, form);
            output.textContent = '(Fill the form to see RDF output)';
            newForm.addEventListener('change', function (event) {
                if (event.detail?.valid) {
                    output.textContent = event.target.serialize();
                }
            });
        }
        function save(e) {
            // onSubmit
            // FIXME: even run on same machien as JENA it results in CORS
            const form = document.getElementById('shaclform');
            const triples = form.serialize();
            const endpoint = 'http://era-ioss01.era.eu.int:3030/ORGS/data'; // <-- Set your endpoint URL

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/turtle',
                    'Charset': 'utf-8'
                },
                body: triples
            })
                .then(response => {
                    if (response.ok) {
                        alert('Data submitted successfully!');
                    } else {
                        alert('Submission failed: ' + response.statusText);
                    }
                })
                .catch(error => {
                    alert('Error submitting data: ' + error);
                });

        }
    </script>
    <div id="topbar">
        <label for="shape-select">Select SHACL shape:</label>
        <select id="shape-select" hx-trigger="change" hx-on="change: updateShaclForm()">
            <option value="form-shapes/ecm-certificate-0.0.0.3.shacl">ECM Certificate</option>
            <option value="form-shapes/ecm-attestation-0.0.0.1.shacl">ECM Attestation</option>
            <option value="form-shapes/mfct-certificate-0.0.0.1.shacl">MFCT Certificate</option>
            <option value="form-shapes/va-c2t-evidence-full-0.0.0.1.shacl">VA C2T Evidence Full</option>
            <option value="form-shapes/va-c2t-admin-0.0.0.3.shacl">VA C2T Admin v0.0.0.3</option>
            <option value="form-shapes/safety-certifcate-A-0.0.0.1.shacl">Safety Certificate A</option>
            <option value="form-shapes/license-0.0.0.1.shacl">Rail Transport Licence</option>
            <option value="form-shapes/organisation-start.shacl">Organisation (full)</option>
            <option value="form-shapes/organisation-site-0.0.0.1.shacl">Site (full)</option>
            <option value="Certificate.ttl">CLD (full)</option>
        </select>
        <span style="color:#888;font-size:0.95em;">(from /TTL/form-shapes/)</span>
    </div>
    <div id="container" hx-include="#output">
        <div id="form-panel" >
            <shacl-form id="shaclform" data-shapes-url="form-shapes/ecm-certificate-0.0.0.3.shacl" data-collapse="open"
                data-language="en" style="width:100%;"></shacl-form>
            <button hx-post="http://10.0.201.105:3030/ORGS/data" hx-trigger="click" hx-include="inherit"
                hx-headers='{"Content-Type": "text/turtle"}'
                hx-on="htmx:afterRequest: (e) => { if(e.detail.xhr.status === 200) alert('Data submitted successfully!'); else alert('Submission failed: ' + e.detail.xhr.statusText); }">Save</button>
        </div>
        <div id="rdf-panel">
            <h3>Generated RDF (Turtle)</h3>
            <pre id="output">(Fill the form to see RDF output)</pre>
        </div>
    </div>
    <script type="module">
        import '@ulb-darmstadt/form-default.js'
        import { registerPlugin } from '@ulb-darmstadt/form-default.js'
        import { LeafletPlugin } from '@ulb-darmstadt/plugins/leaflet.js'
        // import { UrlPlugin } from '@ulb-darmstadt/url.js'
        import { ButtonPlugin } from '@demoutiez/button.js'
        import { SelectorPlugin } from '@demoutiez/selector.js'
        import { TreeSelectorPlugin } from '@demoutiez/tree-selector.js'

        // Initial form event binding
        const form = document.getElementById('shaclform');

        form.addEventListener('change', function (event) {
            const output = document.getElementById('output');
            if (event.detail?.valid) {
                output.textContent = event.target.serialize();
            }
        });
        
        // form.addEventListener('submit', save())
        form.registerPlugin(new LeafletPlugin({ datatype: 'http://www.opengis.net/ont/geosparql#wktLiteral' }))
        form.registerPlugin(new SelectorPlugin(
            { predicate: 'http://www.w3.org/ns/org#siteOf' },
            'Please select a record:',
            window.location.protocol + '//' + window.location.host + '/iss/TS/query',
            'PREFIX iss: <http://data.europa.eu/949/iss/>' +
            'PREFIX skos: <http://www.w3.org/2004/02/skos/core#>' +
            'PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>' +
            'SELECT DISTINCT ?Record ?Type ?Title ?Entity ?Creation ' +
            'WHERE {' +
            '  GRAPH <${sessionScope.graphname}> {' +
            '    ?Record rdf:type iss:Record ;' +
            '            iss:recordType ?Type ;' +
            '            iss:recordTitle ?Title ;' +
            '            iss:reportingEntityName ?Entity ;' +
            '            iss:recordDateTime ?Creation ;' +
            '            iss:recordId ?ID .' +
            '    FILTER (?Type = "RCM"^^skos:Concept)' +
            '  }' +
            '}',
            'Record',
            'RecordViewer.jsp?id='
        ))

    </script>
</body>

</html>