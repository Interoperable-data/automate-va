@base <http://data.europa.eu/949/> .
@prefix era: <http://data.europa.eu/949/> .
@prefix era-sh: <http://data.europa.eu/949/shapes/> .

# From examples
@prefix erapod: <https://storage.inrupt.com/ea779a2c-b43d-4723-8b1a-aaa8990dd576/data/eradis/> .
@prefix gotham: <https://batman.fandom.com/wiki/> .

# General
@prefix as:    <https://www.w3.org/ns/activitystreams#> .
@prefix cc:    <http://creativecommons.org/ns#> .
@prefix dash:  <http://datashapes.org/dash#> .
@prefix dcat:  <http://www.w3.org/ns/dcat#> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix dct:  <http://purl.org/dc/terms/> .
@prefix dul:  <http://www.ontologydesignpatterns.org/ont/dul/DUL.owl#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix geo:  <http://www.opengis.net/ont/geosparql#> .
@prefix gr:   <http://purl.org/goodrelations/v1#> .
@prefix org:  <http://www.w3.org/ns/org#> .
@prefix owl:  <http://www.w3.org/2002/07/owl#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix schema:  <http://schema.org/> .
@prefix sh:   <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix time: <http://www.w3.org/2006/time#> .
@prefix unit: <http://qudt.org/vocab/unit/> .
@prefix vcard: <http://www.w3.org/2006/vcard/ns#> .
@prefix vpa: <http://w3id.org/vpa#> .
@prefix vs: <http://www.w3.org/2003/06/sw-vocab-status/ns#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# Domain-specific
@prefix era-cld: <http://data.europa.eu/949/eradis/clds/> .
@prefix era-cfg: <http://data.europa.eu/949/vehicleTypeConfigurations/> .
@prefix era-ecd: <http://data.europa.eu/949/eradis/declarations/> .
@prefix eralex: <http://data.europa.eu/949/requirement/legislation/> .
@prefix rorg: <http://data.europa.eu/949/organisations/> .
@prefix lorg: <http://data.europa.eu/949/organisations/sites/> .
@prefix uorg: <http://data.europa.eu/949/organisations/units/> .
@prefix eratv: <http://data.europa.eu/949/vehicleTypes/> .
@prefix erava: <http://data.europa.eu/949/vehicleTypeAuthorisations/> .
@prefix eravr: <http://data.europa.eu/949/vehicles/registrations/> .
@prefix evr: <http://data.europa.eu/949/vehicles/> .
@prefix iss: <http://data.europa.eu/949/iss/> . 


# Relevant SKOS Concept Schemes
@prefix era-skos: <http://data.europa.eu/949/concepts/> .
@prefix era-cld-types: <http://data.europa.eu/949/concepts/cld-types/> .
@prefix era-ecd-types: <http://data.europa.eu/949/concepts/ecd-types/> .
@prefix era-cld-modules: <http://data.europa.eu/949/concepts/cld-modules/> .
@prefix era-organisation-roles: <http://data.europa.eu/949/concepts/organisation-roles/> .
@prefix era-states: <http://data.europa.eu/949/concepts/states/> .
@prefix era-va-authcase: <http://data.europa.eu/949/concepts/va-authcases/> .
@prefix era-vtc: <http://data.europa.eu/949/concepts/vehicle-type-configurations/> .
@prefix era-vehicle-types-eratv: <http://data.europa.eu/949/concepts/vehicle-types/eratv/> .
# unused @prefix era-vehicle-types: <http://data.europa.eu/949/concepts/vehicle-types/> .
@prefix era-ntg-rinf: <http://data.europa.eu/949/concepts/nominal-track-gauges/rinf/> .
@prefix era-ess-rinf: <http://data.europa.eu/949/concepts/energy-supply-systems/rinf/> .
@prefix era-noic: <http://data.europa.eu/949/concepts/noise-categories/NoiseCategories/> .
@prefix era-va-trm: <http://data.europa.eu/949/concepts/va-type-registration-methods/> .

 # WARNING: DO NOT (YET) EXIST
@prefix era-permission-types: <http://data.europa.eu/949/concepts/permission-types/> .
@prefix era-ecm-maintenance-functions: <http://data.europa.eu/949/concepts/ecm-maintenance-functions/> .
@prefix era-lex-sections: <http://data.europa.eu/949/concepts/requirements/section/> .
@prefix era-pava-at: <http://data.europa.eu/949/concepts/va-authassessment-types/> .
@prefix era-etcsmanspecset: <http://data.europa.eu/949/concepts/etcs-mandatory-specifications-set/> .
@prefix erava-orgroletasks: <http://data.europa.eu/949/concepts/org-role-tasks/> .
@prefix issform:  <http://era.europa.eu/forms/iss/> . 

# From ISS
@prefix iss-skos: <https://raw.githubusercontent.com/Interoperable-data/ISS_vocabulary/refs/heads/main/iss-skos/> .
@prefix iss-rs:   <http://data.europa.eu/949/iss/concepts/record-statuses/> .

# For inclusion in the ERA ontology, after review
# Do not use currently
era-sh:CLD a 
    owl:Class , sh:NodeShape ;
    rdfs:subClassOf era-sh:TimeBoundDocument, vpa:EvidenceDocument ;
    dcterms:created "2024-10-25"^^xsd:date ;

    rdfs:comment """Certification Level Documents (CLD) issued by NoBos are:
    • EC Certificates
    • QMS-Approvals
    and whether these are Intermediate Statements of Verification (ISVs).

    The EU legislative documents 768/2008/EC, (EU) 2016/797, (EU) 2019/250 and 2010/713/EU establish a number of requirements on the content of CLDs."""@en ;
    rdfs:isDefinedBy <http://data.europa.eu/949/> ;
    rdfs:seeAlso "https://nb-rail.eu/official-documents?_hash=sdZw5f9knrCRlgtc8tjzq263IkcdQhDo05f6n%2FKVqUA%3D&ctx=a%3A1%3A%7Bs%3A2%3A%22id%22%3Bi%3A154%3B%7D&p=documents%2FRFU%2FAll+subsystems%2FRFU-STR-001+Content+of+EC+Certificates.pdf";
    rdfs:label "Certification Level Documents"@en ;
    dcterms:source <http://data.europa.eu/eli/dec/2008/768(1)/oj>, 
        <http://data.europa.eu/eli/dir/2016/797/2020-05-28>,
        <http://data.europa.eu/eli/reg_impl/2019/250/2020-06-16>,
        <http://data.europa.eu/eli/dec/2010/713/oj> ;

    sh:targetClass era:CLD  ;
    sh:declare [
        sh:prefix "era" ;
        sh:namespace "http://data.europa.eu/949/"^^xsd:anyURI 
    ];
    sh:declare [
        sh:prefix "vpa" ;
        sh:namespace "http://w3id.org/vpa#"^^xsd:anyURI 
    ];
    sh:declare [
        sh:prefix "dcterms" ;
        sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI 
    ];
    sh:declare [
        sh:prefix "skos" ;
        sh:namespace "http://www.w3.org/2004/02/skos/core#"^^xsd:anyURI 
    ];
    sh:declare [
        sh:prefix "rdfs" ;
        sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI 
    ];
    sh:declare [
        sh:prefix "xsd" ;
        sh:namespace "http://www.w3.org/2001/XMLSchema#"^^xsd:anyURI 
    ];

    # --- CLD properties (updated for real data) ---
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:identifier ;
        sh:name "CLD identifier"@en ;
        sh:datatype xsd:string ;
        sh:nodeKind sh:Literal ;
        sh:description "The CLD ID, as defined in RFU-STR-001."@en;
        sh:message "The CLD ID, as defined in RFU-STR-001, MUST be present."@en;
        sh:severity sh:Violation ;
        sh:minCount 1;
        sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path vpa:versionNumber ;
        sh:name "CLD Version Number"@en ;
        sh:datatype xsd:integer ;
        sh:nodeKind sh:Literal ;
        sh:description "The Version Counter of the CLD, as defined in RFU-STR-001."@en;
        sh:message "The Version Counter of the CLD, as defined in RFU-STR-001, MUST be present."@en;
        sh:severity sh:Violation ;
        sh:minCount 1;
        sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:created ;
        sh:name "CLD entry created in KG"@en ;
        sh:datatype xsd:date ;
        sh:nodeKind sh:Literal ;
        sh:description "Date the CLD was created in ERADIS+."@en ;
        sh:message "Date the CLD was created in ERADIS+ MUST be present."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ;
        sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:issued ;
        sh:name "CLD Issue date"@en ;
        sh:datatype xsd:date ;
        sh:nodeKind sh:Literal ;
        sh:description "Date the CLD was issued by the CAB."@en ;
        sh:message "Date the CLD was issued by the CAB, MUST be present."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ;
        sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:replaces ;
        sh:name "Which CLD this CLD replaces"@en ;
        sh:nodeKind sh:IRI ;
        sh:description "The previous CLD replaced by this one, if any."@en ;
        sh:message "(Check) This CLD replaces no other CLD."@en ;
        sh:severity sh:Warning ;
        sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:type ;
        sh:name "CLD type"@en ;
        sh:nodeKind sh:IRI ;
        sh:description "SKOS Concept indicating what type of CLD is represented."@en ;
        sh:message "Type of CLD MUST be present."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ;
        sh:maxCount 1
    ];
    # see next sparql constraint sh:property [
    #     a sh:PropertyShape ;
    #     sh:path dcterms:conformsTo ;
    #     sh:name "CLD module"@en ;
    #     sh:nodeKind sh:IRI ;
    #     sh:class skos:Concept ;
    #     sh:description "CLD Module (SKOS Concept) must be present."@en ;
    #     sh:message "Module MUST be included as exactly ONE SKOS Concept (module)."@en ;
    #     sh:severity sh:Violation ;
    #     sh:minCount 2 ;
    # ];
    # See next sparql constraint sh:property [
    #     a sh:PropertyShape ;
    #     sh:path dcterms:conformsTo ;
    #     sh:name "Conforming ERA Document SHOULD be present"@en ;
    #     sh:nodeKind sh:BlankNodeOrIRI ;
    #     sh:class era:Document ;
    #     sh:description "The latest version of ERA `Technical Document 000MRA1044` to which the CLD conforms should be included as exactly one era:Document (ERA Technical Document)."@en ;
    #     sh:message "Preferably, the ERA Technical Document 000MRA1044 to which the CLD conforms SHOULD be included as exactly one era:Document (ERA Technical Document)."@en ;
    #     sh:severity sh:Warning ;
    #     sh:minCount 1 ; sh:maxCount 1 ;
    # ];
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:severity sh:Warning ;
        sh:message "No `era:Document` (representing ERA Technical Document 000MRA1044) is present in `dcterms:conformsTo`."@en ;
        sh:prefixes dcterms: , era: , vpa: ;
        sh:select """
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX era: <http://data.europa.eu/949/>
            SELECT $this WHERE {
              FILTER NOT EXISTS {
                $this dcterms:conformsTo ?doc .
                ?doc a era:Document .
              }
            }
        """
    ] ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:severity sh:Violation ;
        sh:description "CLD Module (SKOS Concept) must be present."@en ;
        sh:message "Module MUST be included as exactly ONE SKOS Concept (module)."@en ;
        sh:prefixes dcterms: , era: , vpa: ;
        sh:select """
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX era: <http://data.europa.eu/949/>
            PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
            SELECT $this (COUNT(?doc) AS ?moduleCount) WHERE {
              $this dcterms:conformsTo ?doc .
              ?doc a skos:Concept .
            } GROUP BY $this HAVING (?moduleCount != 1)
        """
    ] ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:severity sh:Violation ;
        sh:message "The `era:Document` in `dcterms:conformsTo` MUST not have a version 1.1 or 2017 as it was issued on {?issued}, which is after Decision ERA-ED-DEC 2110-2022 of 13/12/2022."@en ;
        sh:prefixes dcterms: , era: , vpa: ;
        sh:select """
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX era: <http://data.europa.eu/949/>
            PREFIX vpa: <http://w3id.org/vpa#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

            SELECT $this ?doc ?comment ?issued WHERE {
              $this dcterms:conformsTo ?doc ; dcterms:issued ?issued .
              ?doc a era:Document ;
                   rdfs:comment ?comment .
              FILTER(
                (CONTAINS(LCASE(STR(?comment)), "1.1") || CONTAINS(LCASE(STR(?comment)), "2017")) &&
                (?issued > "2022-12-13"^^xsd:date)
              )
            }
        """
    ] ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:severity sh:Violation ;
        sh:message "No SKOS Concept (for the module) is present in dcterms:conformsTo."@en ;
        sh:prefixes dcterms: , era: , vpa: ;
        sh:select """
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
            SELECT $this WHERE {
            FILTER NOT EXISTS {
                $this dcterms:conformsTo ?mod .
                ?mod a skos:Concept .
            }
            }
        """
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:subject ;
        sh:name "CLD Subject of Assessment"@en ;
        sh:nodeKind sh:IRI ;
        sh:or (
            [ sh:class era:IC ]
            [ sh:class era:TSI ]
        ) ;
        sh:description "Object of assessment be an era:IC and/or era:TSI). If an IC, exactly one; if TSI, multiple allowed."@en ;
        sh:message "Object of assessment MUST be an era:IC or era:TSI. If an IC, exactly one; if TSI, multiple allowed. If no TSI, warning. If no subject, violation."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ;
        sh:sparql [
            a sh:SPARQLConstraint ;
            sh:message "There must be at most one era:IC as dcterms:subject."@en ;
            sh:prefixes dcterms: , era: , vpa: ;
            sh:select """
                PREFIX dcterms: <http://purl.org/dc/terms/>
                PREFIX era: <http://data.europa.eu/949/>
                PREFIX vpa: <http://w3id.org/vpa#>

                SELECT $this (COUNT(?ic) AS ?icCount) WHERE {
                  $this dcterms:subject ?ic .
                  ?ic a era:IC .
                } GROUP BY $this HAVING (?icCount > 1)
            """
        ] ;
        sh:sparql [
            a sh:SPARQLConstraint ;
            sh:severity sh:Warning ;
            sh:message "No `era:TSI` is present as `dcterms:subject`."@en ;
            sh:prefixes dcterms: , era: , vpa: ;
            sh:select """
                PREFIX dcterms: <http://purl.org/dc/terms/>
                PREFIX era: <http://data.europa.eu/949/>
                PREFIX vpa: <http://w3id.org/vpa#>

                SELECT $this WHERE {
                  FILTER NOT EXISTS { $this dcterms:subject ?tsi . ?tsi a era:TSI }
                }
            """
        ]
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path vpa:checkedCompliance ;
        sh:name "CLD Compliances Checked"@en ;
        sh:nodeKind sh:BlankNodeOrIRI ;
        sh:or (
            [ sh:class era:CABAssessmentCheck ]
            [ sh:class era:CABAuditCheck ]
        ) ;
        sh:description "Any compliance or audit checks (CABAssessmentCheck or CABAuditCheck) performed for this CLD."@en ;
        sh:message "CLD contains no compliance or audit checks (CABAssessmentCheck or CABAuditCheck)."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:description ;
        sh:name "CLD description"@en ;
        sh:datatype xsd:string ;
        sh:nodeKind sh:Literal ;
        sh:description "Human-readable description of the CLD."@en ;
        sh:message "Human-readable Object of Assessment of the CLD MUST be present."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ; sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path rdfs:seeAlso ;
        sh:name "CLD link to ERADIS URL"@en ;
        sh:datatype xsd:anyURI ;
        sh:nodeKind sh:Literal ;
        sh:description "The ERADIS or other URL of the CLD, if available."@en ;
        sh:message "(Check) No ERADIS or other URL of the CLD available?"@en ;
        sh:severity sh:Warning ;
        sh:minCount 1 ; sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path vpa:valid ;
        sh:name "CLD time validity"@en ;
        sh:nodeKind sh:BlankNodeOrIRI ;
        sh:class time:ProperInterval ;
        sh:description "Validity interval of the CLD."@en ;
        sh:message "Validity interval of the CLD MUST be present."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1 ; sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:audience ;
        sh:name "Organisation receiving the CLD"@en ;
        sh:class era:OrganisationRole ;
        sh:nodeKind sh:BlankNodeOrIRI ;
        sh:description "The organisation using the CLD as Applicant (must be an era:OrganisationRole)."@en ;
        sh:message "Organisation using the CLD as Applicant MUST be an `era:OrganisationRole`, not an `era:Body`."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:node [
            sh:property [
                sh:path era:roleOf ;
                sh:name "The IRI of the receiving organisation"@en ;
                sh:description "The body to which this role applies (must be an era:Body)."@en ;
                sh:message "Exactly one `era:Body` must be linked to as the Applicant." ;
                sh:nodeKind sh:IRI ;
                sh:class era:Body ;
                sh:severity sh:Violation ;
                sh:minCount 1 ; sh:maxCount 1
            ] ;
            sh:property [
                sh:path era:hasOrganisationRole ;
                sh:name "The role of the receiving Organisation"@en ;
                sh:nodeKind sh:IRI ;
                sh:description "The role held, must be a SKOS Concept from era-organisation-roles."@en ;
                sh:in (era-organisation-roles:Applicant era-organisation-roles:Manufacturer ) ; # TODO: To be checked
                sh:message "No role of Applicant was linked to the OrganisationRole for the CLD receiving organisation.";
                sh:severity sh:Violation;
                sh:minCount 1 ; sh:maxCount 1
            ]
        ] ;
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:contributor ;
        sh:name "Involved organisations"@en ;
        sh:class era:OrganisationRole ;
        sh:nodeKind sh:BlankNodeOrIRI ;
        sh:description "The manufacturer involved in the assessment (must be an era:OrganisationRole)."@en ;
        sh:message "No Manufacturer involved in the assessment (missing era:OrganisationRole)."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1 ;
        sh:node [
            sh:property [
                sh:path era:roleOf ;
                sh:name "The IRI of the involved organisation"@en ;
                sh:nodeKind sh:IRI ;
                sh:class era:Body ;
                sh:description "The body to which this role applies (must be an era:Body)."@en ;
                sh:message "No involved `era:Body` was linked to this CLD (normally the Manufacturer)." ;
                sh:severity sh:Warning ;
                sh:minCount 1 ;
            ] ;
            sh:property [
                sh:path era:hasOrganisationRole ;
                sh:name "The role of the involved Organisation"@en ;
                sh:nodeKind sh:IRI ;
                sh:description "The role held, must be a SKOS Concept from era-organisation-roles."@en ;
                sh:in (era-organisation-roles:Manufacturer era-organisation-roles:AssessmentBody) ; # TODO: to be checked
                sh:minCount 1 ;
                sh:message "For the organisation(s) contributing to the CLD, no role(s) were linked to. We therefore cannot determine how they contributed." ;

                sh:severity sh:Warning 
                
            ]
        ] ;

    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:creator ;
        sh:name "The CAB producing the CLD"@en ;
        sh:class era:OrganisationRole ;
        sh:nodeKind sh:BlankNodeOrIRI ;
        sh:description "CAB issuing the CLD (must be an era:OrganisationRole, with `era:roleOf` and `era:hasOrganisationRole`)."@en ;
        sh:message "CAB issuing the CLD MUST be an `era:OrganisationRole` (not an `era:Body`)."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:node [
            sh:property [
                sh:path era:roleOf ;
                sh:name "The IRI of the issuing organisation"@en ;
                sh:nodeKind sh:IRI ;
                sh:class era:Body ;
                sh:description "The body to which this role applies (must be an era:Body)."@en ;
                sh:message "The era:Body (CAB) with role NoBo MUST be linked to in the OrganisationRole.";
                sh:severity sh:Violation;
                sh:minCount 1 ; sh:maxCount 1
            ] ;
            sh:property [
                sh:path era:hasOrganisationRole ;
                sh:name "The role of the issuing Organisation"@en ;
                sh:nodeKind sh:IRI ;
                sh:description "The role held, must be a SKOS Concept from era-organisation-roles."@en ;
                sh:message "No role of NoBo@CAB was linked to the OrganisationRole for the CLD issuing organisation.";
                
                sh:in (era-organisation-roles:CAB era-organisation-roles:AssessmentBody era-organisation-roles:NoBo ) ; # TODO: to be checked
                sh:severity sh:Violation;
                sh:minCount 1 ; sh:maxCount 1
            ]
        ] ;
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:source ;
        sh:name "CLD: Covered Directives"@en ;
        sh:nodeKind sh:IRI ;
        sh:class vpa:Requirement ;
        sh:description "Legal Requirement(s), but not TSI's, covered by the CLD. Must be a `vpa:Requirement`, and NOT an `era:TSI` or `era:IC`."@en ;
        sh:message "The property `dcterms:source` MUST be present and link to a `vpa:Requirement` that is not an `era:TSI` nor an `era:IC`."@en ;
        sh:sparql [
            a sh:SPARQLConstraint ;
            sh:message "dcterms:source must not be an era:TSI or era:IC."@en ;
            sh:prefixes dcterms: , era: , vpa: ;
            sh:select """
                PREFIX dcterms: <http://purl.org/dc/terms/>
                PREFIX era: <http://data.europa.eu/949/>
                PREFIX vpa: <http://w3id.org/vpa#>
                SELECT $this ?covered WHERE {
                  $this dcterms:source ?covered .
                  FILTER (EXISTS { ?covered a era:TSI } || EXISTS { ?covered a era:IC })
                }
            """
        ] ;
        sh:minCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:spatial ;
        # FIXME: if the module is 4 then this should be a Violation!
        sh:name "CLD: spatial validity to a Site"@en ;
        sh:nodeKind sh:BlankNodeOrIRI ;
        sh:class org:Site ;
        sh:description "Manufacturing or assessment site(s), if relevant."@en ;
        sh:message "No Manufacturing or assessment site(s) mentioned in the CLD."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path rdfs:comment ;
        sh:name "CLD comment"@en ;
        sh:datatype xsd:string ;
        sh:nodeKind sh:Literal ;
        sh:description "Free-text comment about the CLD."@en ;
        sh:message "No Free-text comment about the CLD is present"@en ;
        sh:severity sh:Warning ;
        sh:minCount 1 ; sh:maxCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path dcterms:isReplacedBy ;
        sh:name "Replacing CLD"@en ;
        sh:nodeKind sh:IRI ;
        sh:description "IRI of the newer CLD that replaces this one, if any."@en ;
        sh:message "(Check) This CLD is not linking to a newer CLD."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1 ; sh:maxCount 1
    ] ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:severity sh:Violation ;
        sh:message "If `dcterms:isReplacedBy` is present, the replacing CLD MUST have a higher `vpa:versionNumber` than this CLD."@en ;
        sh:prefixes dcterms: , era: , vpa: ;
        sh:select """
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX era: <http://data.europa.eu/949/>
            PREFIX vpa: <http://w3id.org/vpa#>
            SELECT $this ?replacer ?thisVersion ?replacerVersion WHERE {
              OPTIONAL { $this vpa:versionNumber ?thisVersion . }
              OPTIONAL { 
                $this dcterms:isReplacedBy ?replacer .
                ?replacer vpa:versionNumber ?replacerVersion . 
              }
              FILTER(bound(?replacer) && bound(?thisVersion) && bound(?replacerVersion) && (?replacerVersion <= ?thisVersion))
            }
        """
    ] ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "If `dcterms:isReplacedBy` is present, the replacing CLD MUST have a later `dcterms:issued` date than this CLD."@en ;
        sh:severity sh:Violation ;
        sh:prefixes dcterms: , era: , vpa: ;
        sh:select """
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX era: <http://data.europa.eu/949/>
            PREFIX vpa: <http://w3id.org/vpa#>
            SELECT $this ?replacer ?thisIssued ?replacerIssued WHERE {
                OPTIONAL { $this dcterms:issued ?thisIssued . }
                OPTIONAL { 
                  $this dcterms:isReplacedBy ?replacer .
                  ?replacer dcterms:issued ?replacerIssued . }
                FILTER(bound(?replacer) && bound(?thisIssued) && bound(?replacerIssued) && (?replacerIssued <= ?thisIssued))
            }
        """
    ] ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Both `dcterms:subject` and `vpa:checkedCompliance/vpa:checkedRequirement` are used to express compliance to TSI/IC. Prefer only one method."@en ;
        sh:prefixes dcterms: , era: , vpa: ;
        sh:severity sh:Warning ;
        sh:select """
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX era: <http://data.europa.eu/949/>
            PREFIX vpa: <http://w3id.org/vpa#>

            SELECT $this ?subj ?req ?check WHERE {
            $this dcterms:subject ?subj .
            FILTER EXISTS {
                $this vpa:checkedCompliance ?check .
                ?check vpa:checkedRequirement ?req .
                FILTER EXISTS { ?subj a ?type . FILTER(?type IN (era:TSI, era:IC)) }
                FILTER EXISTS { ?req a ?type2 . FILTER(?type2 IN (era:TSI, era:IC)) }
            }
            }
        """
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path era:resultStatement ;
        sh:name "CLD Assessment Result"@en ;
        sh:or ( [sh:datatype xsd:string ] [sh:datatype rdf:langString ] ) ;
        sh:nodeKind sh:Literal ;
        sh:description "Assessment result (free text, required)."@en ;
        sh:message "Assessment result is required."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ; sh:maxCount 1
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path era:validityStatement ;
        sh:name "CLD Validity Statement"@en ;
        sh:or ( [sh:datatype xsd:string ] [sh:datatype rdf:langString ] ) ;
        sh:nodeKind sh:Literal ;
        sh:description "Validity statement (free text, required)."@en ;
        sh:message "Validity statement is required."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1 ; sh:maxCount 1
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path era:sequenceStatement ;
        sh:name "CLD Sequence Statement"@en ;
        sh:or ( [sh:datatype xsd:string ] [sh:datatype rdf:langString ] ) ;
        sh:nodeKind sh:Literal ;
        sh:description "Sequence statement (free text, optional)."@en ;
        sh:message "Sequence statement is not present."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1 ; sh:maxCount 1
    ] ;
.

# --- CABCheck shape (for vpa:checkedCompliance, covers both assessment and audit checks) ---
era-sh:CABCheckShape a sh:NodeShape ;
    sh:targetClass era:CABAssessmentCheck, era:CABAuditCheck ;
    sh:property [
        a sh:PropertyShape ;
        sh:path vpa:checkedSection ;
        sh:name "Sections checked"@en ;
        sh:nodeKind sh:IRI ;
        sh:description "Section of the legal text checked in this check."@en ;
        sh:message "The CAB's Check does not refer to a section of legal text."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:or (
            [
                sh:path vpa:isCompliant ;
                sh:name "Compliance Check (Y/N)"@en ;
                sh:datatype xsd:boolean ;
                sh:nodeKind sh:Literal ;
                sh:description "Whether the section is compliant (true/false)."@en ;
                sh:message "The CAB's Check has not expressed compliance using `vpa:isCompliant`."@en ;
                sh:severity sh:Warning ;
                sh:maxCount 1; sh:minCount 1
            ]
            [
                sh:path era:isCompliant ;
                sh:name "Compliance Check (Yes/No/Partial/...)"@en ;
                sh:nodeKind sh:IRI ;
                sh:class skos:Concept ;
                sh:description "IRI to a skos:Concept indicating compliance (Y/N/P)."@en ;
                sh:message "The CAB's Check has not expressed compliance using `era:isCompliant`."@en ;
                sh:severity sh:Warning ;
                sh:maxCount 1; sh:minCount 1
            ]
        )
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path vpa:checkedRequirement ;
        sh:name "The Legal source of the check"@en ;
        sh:nodeKind sh:IRI ;
        sh:description "Legal requirement(s) checked in this check."@en ;
        sh:message "The CAB's Check has not cited the Legal reference used (TSI, or other LegalWork)."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path vpa:withRestriction ;
        sh:name "Restriction formulated during Check"@en ;
        sh:nodeKind sh:BlankNodeOrIRI ;
        sh:class era:CABRestriction ;
        sh:description "Restriction, addition, or condition (CLOU) attached to this check."@en ;
        sh:message "The CAB's Check has not expressed any Restriction."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path rdfs:comment ;
        sh:name "Check comment"@en ;
        sh:datatype xsd:string ;
        sh:nodeKind sh:Literal ;
        sh:description "Free-text comment about the check."@en ;
        sh:message "The CAB's Check was not commented."@en ;
        sh:severity sh:Warning ;
        sh:maxCount 1; sh:minCount 1
    ] ;
    sh:property [
        a sh:PropertyShape ;
        sh:path rdfs:seeAlso ;
        sh:name "seeAlso"@en ;
        sh:datatype xsd:anyURI ;
        sh:nodeKind sh:Literal ;
        sh:description "Reference to supporting documents or reports."@en ;
        sh:message "The CAB's Check has not refered to a further documented reference URL."@en ;
        sh:severity sh:Warning ;
        sh:minCount 1
    ] .

# Section 2 of a vehicle type should be resolved through Restriction and Compliance resources.
# Conformity of a VehicleType to TSI's
era-sh:TSIConformity a 
    owl:Class , sh:NodeShape , vpa:Restriction ;
    dcterms:created "2024-10-25"^^xsd:date ;
    # dcterms:modified "_RESERVED_"^^xsd:date ;

    ## definitions ----------
    rdfs:label "Vehicle Type Certificate: Conformity with TSI"@en;
    rdfs:seeAlso "https://eur-lex.europa.eu/eli/dec_impl/2011/665/2023-09-08#anx_II"^^xsd:anyURI ;
    dcterms:source <http://data.europa.eu/eli/dec_impl/2011/665/2023-09-08> ;

    ## Properties -----------
    sh:property [
        a sh:PropertyShape ;
        sh:name "TSI Check restriction related to TSI"@en ;
        sh:path vpa:regarding ;
        sh:nodeKind sh:IRI ;
        sh:class era:Requirement ; # Use an exact link to the vehicle-related TSI examined /ERALEX
        sh:description "The TSI for which conformity was checked in this VehicleType. Selection from a predefined list of vehicle related TSIs (both in force and those that were previously in force) (multiple selection possible)"@en ;
        sh:message "The TSI conformity did not express what TSI was the source."@en ;
        sh:severity sh:Violation ;
        sh:minCount 1
    ].

era-sh:TSIComplianceCheck  a 
    owl:Class , sh:NodeShape ;
    rdfs:subClassOf vpa:Compliance ;
    rdfs:comment "This shape protects a type against abesence of 2.2 or 2.3" ;
    dcterms:created "2024-10-25"^^xsd:date ;
    # dcterms:modified "_RESERVED_"^^xsd:date ;

    # FIXME: targetClass is missing and exact use is not certain through Certifcate,
   # It may not be era:VehicleType but the compliance check IN there.

    ## definitions ----------
    rdfs:label "Vehicle Type Certificate: Conformity with TSI - compliance check"@en;
    rdfs:seeAlso "https://eur-lex.europa.eu/eli/dec_impl/2011/665/2023-09-08#anx_II" ;
    dcterms:source <http://data.europa.eu/eli/dec_impl/2011/665/2023-09-08> ;

    ## properties
    sh:property [
        a sh:PropertyShape ;
        sh:inversePath vpa:checked ;
        sh:name "checked"@en ;
        sh:class era-sh:CLD ; # FIXME: cannot be right
        era:eratvIndex "2.2" ;
        sh:description  "The certificate, to be mentioned under 2.2 of the VehicleType, which examined Sections and Specific Cases, and their conclusion."@en ;
        # "EC certificate of verification : Reference of ‘EC type examination certificates’ (if module SB applied) and/or ‘EC design examination certificates’ (if module SH1 applied)"@en
        sh:message "The certificate, to be mentioned under 2.2 of the VehicleType, which examined Sections and Specific Cases, and their conclusion. EC certificate of verification : Reference of ‘EC type examination certificates’ (if module SB applied) and/or ‘EC design examination certificates’ (if module SH1 applied)"@en ;
        sh:severity sh:Warning ;
        sh:minCount 1

    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path era:isCompliant ; ## see vpa:isCompliant (allows only boolean)
        sh:name "TSI Compliance Check Result"@en ;
        sh:nodeKind sh:IRI ;
        era:inSkosConceptScheme <http://data.europa.eu/949/concepts/tsi-conformities/ConformityResults/> ;# to be created in ERA Vocabulary
        sh:class <http://www.w3.org/2004/02/skos/core#Concept> ; 
        sh:description "Y: Compliant, N: Non-compliant, P: Partially compliant."@en
        ;
        sh:message "The type's TSI Compliance Check has not expressed compliance using `era:isCompliant`."@en ;
        sh:severity sh:Warning ;
        sh:maxCount 1; sh:minCount 1
    ];
    sh:property [
        a sh:PropertyShape ;
        sh:path era:checkedSection ;
        sh:name "TSI Compliance Check (Section checked)"@en ;
        sh:nodeKind sh:IRI ;
        sh:or (
            [
                era:inSkosConceptScheme <http://data.europa.eu/949/concepts/tsi-conformities/TSISpecificCases/> ;# to be created in ERA Vocabulary
                sh:class <http://www.w3.org/2004/02/skos/core#Concept> ; 
                sh:description "Applicable specific cases (specific cases conformity with which has been assessed)."@en ;
                sh:message "The type's TSI Compliance Check does not contain `Applicable specific cases`."@en ;
                sh:severity sh:Warning ;
                era:eratvIndex "2.3" ;
                sh:maxCount 1; sh:minCount 1
            ]
            [
                era:inSkosConceptScheme <http://data.europa.eu/949/concepts/tsi-conformities/TSISections> ;# to be created in ERA Vocabulary
                sh:class <http://www.w3.org/2004/02/skos/core#Concept> ; 
                sh:description "Sections of TSI not complied with."@en ;
                sh:message "The type's TSI Compliance Check does not contain `Sections of TSI not complied with`."@en ;
                sh:severity sh:Warning ;
                era:eratvIndex "2.1" ;
                sh:maxCount 1; sh:minCount 1

                # Instances of this TSIComplianceCheck must have vpa:isCompliant "false"^^xsd:boolean
            ]
        )
    ];

    ## TODO: In some cases, the ComplianceCheck MUST be linked to a Vehicle Configuration
    sh:property [
        a sh:PropertyShape ;
        sh:name "Compliance Check TSI valid for Configuration"@en ;
        sh:path era:forConfiguration ;
        sh:nodeKind sh:IRI ;
        sh:class era-sh:VehicleTypeConfiguration ;
        sh:minCount 1 ;
        sh:severity sh:Violation ;
        sh:message "The type's TSI Compliance Check does not contain a link to the Configuration it is applicable for."
    ]
.
